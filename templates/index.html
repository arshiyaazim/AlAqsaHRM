{% extends "base.html" %}

{% block title %}Al-Aqsa Security - Attendance Tracker{% endblock %}

{% block head %}
<style>
    .clock-container {
        text-align: center;
        padding: 20px 0;
    }
    
    .current-time {
        font-size: 3rem;
        font-weight: bold;
    }
    
    .current-date {
        font-size: 1.2rem;
        margin-bottom: 10px;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .action-buttons .btn {
        flex: 1;
        padding: 15px;
        font-size: 1.1rem;
    }
    
    .camera-preview {
        width: 100%;
        border-radius: 10px;
        margin-top: 15px;
        display: none;
    }
    
    .location-info {
        margin-top: 15px;
        font-size: 0.9rem;
    }
    
    .card-attendance {
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
        overflow: hidden;
    }
    
    .card-header-attendance {
        background-color: #4e73df;
        color: white;
        font-weight: bold;
        padding: 15px;
    }
    
    .coordinates {
        color: #666;
        font-family: monospace;
        font-size: 0.85rem;
    }
    
    .btn-clock-in {
        background-color: #1cc88a;
        border-color: #1cc88a;
    }
    
    .btn-clock-out {
        background-color: #e74a3b;
        border-color: #e74a3b;
    }
    
    .status-indicator {
        height: 15px;
        width: 15px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .status-acquiring {
        background-color: #f6c23e;
        animation: blink 1s infinite;
    }
    
    .status-success {
        background-color: #1cc88a;
    }
    
    .status-error {
        background-color: #e74a3b;
    }
    
    @keyframes blink {
        0% { opacity: 0.3; }
        50% { opacity: 1; }
        100% { opacity: 0.3; }
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card card-attendance mb-4">
            <div class="card-header-attendance">
                <i class="bi bi-clock"></i> Attendance Tracker
            </div>
            <div class="card-body">
                <div class="clock-container">
                    <div class="current-date" id="currentDate">Loading date...</div>
                    <div class="current-time" id="currentTime">00:00:00</div>
                </div>
                
                <form id="attendanceForm" action="{{ url_for('submit') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="employee_id" class="form-label">Employee ID</label>
                        <input type="text" class="form-control form-control-lg" id="employee_id" name="employee_id" required placeholder="Enter your employee ID">
                    </div>
                    
                    <div class="mb-3">
                        <label for="project_id" class="form-label">Project (Optional)</label>
                        <select class="form-select form-select-lg" id="project_id" name="project_id">
                            <option value="">-- Select Project --</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>Location</span>
                            <span class="location-status">
                                <span id="locationStatus" class="status-indicator status-acquiring"></span>
                                <span id="locationStatusText">Acquiring location...</span>
                            </span>
                        </label>
                        <div class="location-info">
                            <div id="locationInfo">Please allow location access when prompted.</div>
                            <div class="coordinates" id="coordinatesInfo"></div>
                        </div>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>Photo (Optional)</span>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="toggleCameraBtn">
                                <i class="bi bi-camera"></i> Take Photo
                            </button>
                        </label>
                        <div id="cameraContainer" style="display: none;">
                            <video id="cameraPreview" class="camera-preview" autoplay playsinline></video>
                            <canvas id="captureCanvas" style="display: none;"></canvas>
                            <div class="d-flex justify-content-center mt-2 mb-3">
                                <button type="button" class="btn btn-primary" id="captureBtn">
                                    <i class="bi bi-camera"></i> Capture
                                </button>
                            </div>
                        </div>
                        <div id="photoPreviewContainer" style="display: none;" class="text-center mt-2">
                            <img id="photoPreview" class="img-fluid img-thumbnail" style="max-height: 200px;">
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-danger" id="retakePhotoBtn">
                                    <i class="bi bi-arrow-repeat"></i> Retake
                                </button>
                            </div>
                        </div>
                        <input type="file" id="photoInput" name="photo" accept="image/*" capture="user" style="display: none;">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Action</label>
                        <div class="btn-group action-buttons" role="group">
                            <input type="radio" class="btn-check" name="action" id="clockIn" value="Clock In" autocomplete="off" checked>
                            <label class="btn btn-clock-in" for="clockIn">
                                <i class="bi bi-box-arrow-in-right"></i> Clock In
                            </label>
                            
                            <input type="radio" class="btn-check" name="action" id="clockOut" value="Clock Out" autocomplete="off">
                            <label class="btn btn-clock-out" for="clockOut">
                                <i class="bi bi-box-arrow-right"></i> Clock Out
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                            <i class="bi bi-check-circle"></i> Submit Attendance
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Clock functionality
    function updateClock() {
        const now = new Date();
        
        // Update time
        const timeElement = document.getElementById('currentTime');
        timeElement.textContent = now.toLocaleTimeString('en-US', { 
            hour12: true,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        // Update date
        const dateElement = document.getElementById('currentDate');
        dateElement.textContent = now.toLocaleDateString('en-US', { 
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    // Update clock immediately and then every second
    updateClock();
    setInterval(updateClock, 1000);
    
    // Location functionality
    let locationAcquired = false;
    const locationStatus = document.getElementById('locationStatus');
    const locationStatusText = document.getElementById('locationStatusText');
    const locationInfo = document.getElementById('locationInfo');
    const coordinatesInfo = document.getElementById('coordinatesInfo');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const submitBtn = document.getElementById('submitBtn');
    
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                // Success callback
                function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // Update UI
                    locationStatus.className = 'status-indicator status-success';
                    locationStatusText.textContent = 'Location acquired';
                    locationInfo.innerHTML = `
                        <strong>Location acquired</strong> with accuracy of ${accuracy.toFixed(1)} meters.
                    `;
                    coordinatesInfo.textContent = `Lat: ${latitude.toFixed(6)}, Long: ${longitude.toFixed(6)}`;
                    
                    // Update form values
                    latitudeInput.value = latitude;
                    longitudeInput.value = longitude;
                    
                    // Enable submit button once location is acquired
                    locationAcquired = true;
                    submitBtn.disabled = false;
                },
                // Error callback
                function(error) {
                    locationStatus.className = 'status-indicator status-error';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            locationStatusText.textContent = 'Permission denied';
                            locationInfo.innerHTML = '<strong class="text-danger">Error:</strong> Location permission denied. Please enable location services to clock in/out.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            locationStatusText.textContent = 'Position unavailable';
                            locationInfo.innerHTML = '<strong class="text-danger">Error:</strong> Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            locationStatusText.textContent = 'Timeout';
                            locationInfo.innerHTML = '<strong class="text-danger">Error:</strong> Location request timed out.';
                            break;
                        case error.UNKNOWN_ERROR:
                            locationStatusText.textContent = 'Unknown error';
                            locationInfo.innerHTML = '<strong class="text-danger">Error:</strong> An unknown error occurred.';
                            break;
                    }
                    
                    // Allow submission even if location is not available
                    submitBtn.disabled = false;
                },
                // Options
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            locationStatus.className = 'status-indicator status-error';
            locationStatusText.textContent = 'Not supported';
            locationInfo.innerHTML = '<strong class="text-danger">Error:</strong> Geolocation is not supported by this browser.';
            
            // Allow submission even if geolocation is not supported
            submitBtn.disabled = false;
        }
    }
    
    // Initialize location tracking
    getLocation();
    
    // Camera functionality
    const toggleCameraBtn = document.getElementById('toggleCameraBtn');
    const cameraContainer = document.getElementById('cameraContainer');
    const cameraPreview = document.getElementById('cameraPreview');
    const captureCanvas = document.getElementById('captureCanvas');
    const captureBtn = document.getElementById('captureBtn');
    const photoPreviewContainer = document.getElementById('photoPreviewContainer');
    const photoPreview = document.getElementById('photoPreview');
    const retakePhotoBtn = document.getElementById('retakePhotoBtn');
    const photoInput = document.getElementById('photoInput');
    
    let stream = null;
    
    toggleCameraBtn.addEventListener('click', function() {
        if (cameraContainer.style.display === 'none') {
            // Start camera
            startCamera();
            cameraContainer.style.display = 'block';
            photoPreviewContainer.style.display = 'none';
            toggleCameraBtn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel';
        } else {
            // Stop camera
            stopCamera();
            cameraContainer.style.display = 'none';
            toggleCameraBtn.innerHTML = '<i class="bi bi-camera"></i> Take Photo';
        }
    });
    
    captureBtn.addEventListener('click', function() {
        // Get the canvas context and draw the current video frame
        const context = captureCanvas.getContext('2d');
        
        // Set canvas dimensions to match video
        captureCanvas.width = cameraPreview.videoWidth;
        captureCanvas.height = cameraPreview.videoHeight;
        
        // Draw the video frame on the canvas
        context.drawImage(cameraPreview, 0, 0, captureCanvas.width, captureCanvas.height);
        
        // Convert canvas to blob and create a file
        captureCanvas.toBlob(function(blob) {
            // Create a File object
            const capturedImage = new File([blob], "captured-photo.jpg", { type: "image/jpeg" });
            
            // Create a FileList-like object
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(capturedImage);
            
            // Set the files property of the file input
            photoInput.files = dataTransfer.files;
            
            // Display preview
            const imageUrl = URL.createObjectURL(blob);
            photoPreview.src = imageUrl;
            photoPreviewContainer.style.display = 'block';
            cameraContainer.style.display = 'none';
            
            // Stop camera
            stopCamera();
            
            // Change button text back
            toggleCameraBtn.innerHTML = '<i class="bi bi-camera"></i> Change Photo';
        }, 'image/jpeg', 0.9);
    });
    
    retakePhotoBtn.addEventListener('click', function() {
        photoPreviewContainer.style.display = 'none';
        startCamera();
        cameraContainer.style.display = 'block';
    });
    
    function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    cameraPreview.srcObject = mediaStream;
                    cameraPreview.style.display = 'block';
                })
                .catch(function(error) {
                    console.error("Error accessing the camera: ", error);
                    alert("Error accessing the camera. Please make sure you've granted camera permissions.");
                    cameraContainer.style.display = 'none';
                    toggleCameraBtn.innerHTML = '<i class="bi bi-camera"></i> Take Photo';
                });
        } else {
            alert("Your browser doesn't support camera access.");
            cameraContainer.style.display = 'none';
        }
    }
    
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => {
                track.stop();
            });
            stream = null;
        }
    }
    
    // Form validation
    const attendanceForm = document.getElementById('attendanceForm');
    const employeeIdInput = document.getElementById('employee_id');
    
    attendanceForm.addEventListener('submit', function(event) {
        // Basic validation
        if (!employeeIdInput.value.trim()) {
            alert('Please enter your Employee ID');
            event.preventDefault();
            return false;
        }
        
        // Everything is valid, allow form submission
        return true;
    });
</script>
{% endblock %}